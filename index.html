<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login & Seleção de Avatar</title>
<style>
@font-face { font-family:'Tungsten Bold'; src:url('Tungsten-Bold.ttf') format('truetype'); font-weight:bold; }
body { margin:0; font-family:Arial,sans-serif; background:#111 url('IMG_2294.jpeg') no-repeat center center fixed; background-size:cover; color:#fff; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; padding:20px; }
.container { background: rgba(0,0,0,0.85); border-radius:16px; padding:40px 30px; width:100%; max-width:450px; display:flex; flex-direction:column; align-items:center; box-shadow:0 4px 12px rgba(0,0,0,0.5);}
h1 { text-align:center; color:#ff8800; font-family:'Tungsten Bold',Arial,sans-serif; margin-bottom:25px; font-size:28px; font-weight:bold; }
input[type="email"], input[type="password"], input[type="text"], button { padding:12px 18px; font-size:16px; border-radius:8px; border:1px solid #555; width:100%; max-width:300px; outline:none; background-color:#222; color:#fff; transition: background-color 0.2s, transform 0.2s; }
input:focus { border-color:#ff8800; background-color:#333; }
button { background-color:#ff8800; color:#111; font-weight:bold; cursor:pointer; margin-top:10px; transition: background-color 0.2s, transform 0.2s; }
button:hover { background-color:#ff9900; transform: scale(1.03);}
.avatar-row { display:flex; overflow-x:auto; gap:12px; padding:8px; max-width:100%; }
.avatar-row img { width:80px; height:80px; border-radius:10px; border:2px solid transparent; cursor:pointer; transition:transform 0.2s, border-color 0.2s; object-fit:cover; flex-shrink:0; }
.avatar-row img:hover { transform: scale(1.1); border-color:#ff8800; }
.avatar-row img.selected { border-color:#ffaa55; box-shadow:0 0 6px #ffaa55; }
.pagination { display:flex; justify-content:space-between; width:100%; max-width:300px; margin-top:12px; }
.pagination button { background-color:#ff8800; color:#111; font-weight:normal; padding:8px 14px; border-radius:6px; }
.pagination button:hover { background-color:#ff9900; }
#configBox { display:none; flex-direction:column; gap:12px; width:100%; max-width:300px; margin-top:20px; }
#gearBtn { position:absolute; top:20px; right:20px; cursor:pointer; font-size:24px; color:#ff8800; }
</style>
</head>
<body>
<div class="container">
  <div id="loginBox">
    <h1>Entrar</h1>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button id="loginBtn">Login / Criar conta</button>
  </div>

  <div id="avatarBox" style="display:none; flex-direction:column; align-items:center;">
    <h1>Escolha seu Avatar</h1>
    <div class="avatar-row" id="avatarRow"></div>
    <div class="pagination">
      <button id="prevBtn">Anterior</button>
      <button id="nextBtn">Próximo</button>
    </div>
    <button id="saveAvatarBtn" style="margin-top:15px;">Salvar Avatar e Continuar</button>
  </div>

  <div id="configBox">
    <h1>Configuração de Conta</h1>
    <input type="text" id="newName" placeholder="Novo Nome">
    <button id="changeNameBtn">Mudar Nome</button>
    <input type="email" id="resetEmail" placeholder="Email para redefinir senha">
    <button id="resetPasswordBtn">Redefinir Senha</button>
    <button id="deleteAccountBtn" style="background:#ff5555; color:#fff;">Apagar Conta</button>
  </div>
</div>
<div id="gearBtn">&#9881;</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, deleteUser, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCA2XWZzavTNdHi_w8X5aASfBTfoLVsghY",
  authDomain: "auto-dance.firebaseapp.com",
  databaseURL: "https://auto-dance-default-rtdb.firebaseio.com",
  projectId: "auto-dance",
  storageBucket: "auto-dance.firebasestorage.app",
  messagingSenderId: "960760470726",
  appId: "1:960760470726:web:f5af55d01df6a2be0d4bc7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Elementos
const loginBtn = document.getElementById('loginBtn');
const loginBox = document.getElementById('loginBox');
const avatarBox = document.getElementById('avatarBox');
const avatarRow = document.getElementById('avatarRow');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const saveAvatarBtn = document.getElementById('saveAvatarBtn');
const gearBtn = document.getElementById('gearBtn');
const configBox = document.getElementById('configBox');
const newNameInput = document.getElementById('newName');
const changeNameBtn = document.getElementById('changeNameBtn');
const resetEmailInput = document.getElementById('resetEmail');
const resetPasswordBtn = document.getElementById('resetPasswordBtn');
const deleteAccountBtn = document.getElementById('deleteAccountBtn');
const emailInput = document.getElementById('email');
const senhaInput = document.getElementById('senha');

let avatars = [];
let currentPage = 0;
const avatarsPerPage = 8;
let selectedAvatar = null;
let currentUser = null;

// LOGIN / CRIAR CONTA
loginBtn.addEventListener('click', async () => {
  const email = emailInput.value.trim();
  const senha = senhaInput.value.trim();
  if(!email || !senha){ alert("Preencha email e senha!"); return; }
  try { await signInWithEmailAndPassword(auth,email,senha); } 
  catch(e){ try{ await createUserWithEmailAndPassword(auth,email,senha); } catch(err){ alert("Erro: "+err.message); } }
});

// DETECTA LOGIN
onAuthStateChanged(auth, async user => {
  if(user){
    currentUser = user;
    loginBox.style.display = 'none';
    avatarBox.style.display = 'flex';
    try {
      const userRef = ref(db, "users/"+user.uid);
      const snapshot = await get(userRef);
      if(snapshot.exists() && snapshot.val().avatar) selectedAvatar = snapshot.val().avatar;
    } catch(err){ console.error(err); }
    loadAvatars();
  } else {
    currentUser = null;
    loginBox.style.display = 'flex';
    avatarBox.style.display = 'none';
    configBox.style.display = 'none';
  }
});

// AVATARES
async function loadAvatars(){
  avatarRow.innerHTML='<p>Carregando...</p>';
  const repoOwner="raphamodelagem3d-lab";
  const repoName="Login";
  const folderPath="Just dance avatars";
  const apiUrl=`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${encodeURIComponent(folderPath)}`;
  try {
    const response=await fetch(apiUrl);
    const files=await response.json();
    avatars=files.filter(f=>(f.name.endsWith('.png')||f.name.endsWith('.jpg')||f.name.endsWith('.jpeg')) && f.download_url);
    currentPage=0;
    showPage(currentPage);
  } catch(err){ avatarRow.innerHTML='<p>Erro ao carregar avatares!</p>'; console.error(err);}
}

function showPage(page){
  avatarRow.innerHTML='';
  const start=page*avatarsPerPage;
  const end=start+avatarsPerPage;
  avatars.slice(start,end).forEach(file=>{
    const img=document.createElement('img');
    img.src=file.download_url; img.alt=file.name;
    if(selectedAvatar===file.download_url) img.classList.add('selected');
    img.onclick=()=>{
      document.querySelectorAll('.avatar-row img').forEach(i=>i.classList.remove('selected'));
      img.classList.add('selected');
      selectedAvatar=file.download_url;
    };
    avatarRow.appendChild(img);
  });
}

prevBtn.addEventListener('click', ()=>{ if(currentPage>0){ currentPage--; showPage(currentPage); } });
nextBtn.addEventListener('click', ()=>{ if((currentPage+1)*avatarsPerPage<avatars.length){ currentPage++; showPage(currentPage); } });

saveAvatarBtn.addEventListener('click', async ()=>{
  if(!selectedAvatar) return alert("Selecione um avatar!");
  try {
    await set(ref(db,"users/"+currentUser.uid), { avatar:selectedAvatar });
    window.location.href="https://raphamodelagem3d-lab.github.io/Auto-dance-Just-dance-/";
  } catch(err){ alert("Erro ao salvar avatar: "+err.message);}
});

// CONFIGURAÇÃO
gearBtn.addEventListener('click', ()=>{ 
  configBox.style.display = configBox.style.display==='flex' ? 'none':'flex';
});

changeNameBtn.addEventListener('click', async ()=>{
  const newName = newNameInput.value.trim();
  if(!newName) return alert("Digite um nome!");
  try { await update(ref(db,"users/"+currentUser.uid),{ name:newName }); alert("Nome atualizado!"); newNameInput.value=''; }
  catch(err){ alert("Erro ao atualizar nome: "+err.message);}
});

resetPasswordBtn.addEventListener('click', async ()=>{
  const email = resetEmailInput.value.trim() || currentUser?.email;
  if(!email) return alert("Informe um email!");
  try { await sendPasswordResetEmail(auth,email); alert("Email de redefinição enviado!"); resetEmailInput.value=''; }
  catch(err){ alert("Erro: "+err.message);}
});

deleteAccountBtn.addEventListener('click', async ()=>{
  if(!confirm("Deseja realmente apagar sua conta?")) return;
  try { await deleteUser(currentUser); alert("Conta apagada!"); window.location.reload(); }
  catch(err){ alert("Erro ao apagar conta: "+err.message+"\nVocê pode precisar logar novamente antes.");}
});
</script>
</body>
</html>