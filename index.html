<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login & Configura√ß√£o de Conta</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
@font-face {
  font-family: 'Tungsten Bold';
  src: url('Tungsten-Bold.ttf') format('truetype');
  font-weight: bold;
}
body {
  margin:0;
  font-family: Arial, sans-serif;
  background: #111 url('IMG_2294.jpeg') no-repeat center center fixed;
  background-size: cover;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
  padding:20px;
}
.container {
  background: rgba(0,0,0,0.85);
  border-radius:16px;
  padding:30px 25px;
  width:100%;
  max-width:450px;
  display:flex;
  flex-direction:column;
  align-items:center;
  box-shadow:0 4px 12px rgba(0,0,0,0.5);
  position:relative;
}
h1 { color:#ff8800; font-family:'Tungsten Bold',Arial,sans-serif; text-align:center; margin-bottom:20px; }
input[type="email"], input[type="password"], button, input[type="text"]{
  width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #555;
  background:#222; color:#fff; font-size:16px; outline:none;
  transition: background 0.2s, border-color 0.2s, transform 0.2s;
}
input:focus { background:#333; border-color:#ff8800; }
button { background:#ff8800; color:#111; font-weight:bold; cursor:pointer; transition:background 0.2s, transform 0.2s; }
button:hover { background:#ff9900; transform:scale(1.03); }
.avatar-box, .config-box, .achievements-box { display:none; width:100%; flex-direction:column; align-items:center; }
.avatar-row, .achievements-row { display:flex; overflow-x:auto; gap:10px; max-width:100%; padding:5px; border:2px solid #555; border-radius:12px; margin-bottom:10px; }
.avatar-row img { width:80px; height:80px; border-radius:10px; object-fit:cover; cursor:pointer; border:2px solid transparent; transition:transform 0.2s, border-color 0.2s; }
.avatar-row img.selected { border-color:#ffaa55; box-shadow:0 0 6px #ffaa55; transform:scale(1.05);}
.achievement { opacity:0; transform:translateX(-30px); transition: all 0.3s ease; display:flex; align-items:center; gap:5px; }
.achievement.show { opacity:1; transform:translateX(0);}
#gearBtn { position:absolute; top:15px; right:15px; cursor:pointer; font-size:22px; }
.xp-display { margin-bottom:10px; font-size:18px; font-weight:bold; color:#ffee00;}
</style>
</head>
<body>
<div class="container">

  <div id="loginBox">
    <h1>Entrar</h1>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button id="loginBtn">Login / Criar conta</button>
  </div>

  <div class="avatar-box" id="avatarBox">
    <h1>Escolha seu Avatar</h1>
    <div class="avatar-row" id="avatarRow"></div>
    <button id="saveAvatarBtn">Salvar Avatar e Continuar</button>
  </div>

  <div class="achievements-box" id="achievementsBox">
    <div class="xp-display" id="xpDisplay">XP: 0</div>
    <h1>Conquistas</h1>
    <div class="achievements-row" id="achievementsRow"></div>
  </div>

  <div class="config-box" id="configBox">
    <h1>Configura√ß√£o de Conta</h1>
    <input type="text" id="newName" placeholder="Novo nome">
    <button id="changeNameBtn">Mudar Nome</button>
    <button id="resetPassBtn">Redefinir Senha</button>
    <button id="deleteAccBtn">Apagar Conta</button>
    <button id="closeConfigBtn">Fechar</button>
  </div>

  <div id="gearBtn">&#9881;</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail, updateProfile, deleteUser, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCA2XWZzavTNdHi_w8X5aASfBTfoLVsghY",
  authDomain: "auto-dance.firebaseapp.com",
  databaseURL: "https://auto-dance-default-rtdb.firebaseio.com",
  projectId: "auto-dance",
  storageBucket: "auto-dance.firebasestorage.app",
  messagingSenderId: "960760470726",
  appId: "1:960760470726:web:f5af55d01df6a2be0d4bc7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const loginBtn = document.getElementById('loginBtn');
const loginBox = document.getElementById('loginBox');
const avatarBox = document.getElementById('avatarBox');
const avatarRow = document.getElementById('avatarRow');
const saveAvatarBtn = document.getElementById('saveAvatarBtn');
const achievementsBox = document.getElementById('achievementsBox');
const achievementsRow = document.getElementById('achievementsRow');
const xpDisplay = document.getElementById('xpDisplay');
const gearBtn = document.getElementById('gearBtn');
const configBox = document.getElementById('configBox');
const closeConfigBtn = document.getElementById('closeConfigBtn');
const newNameInput = document.getElementById('newName');
const changeNameBtn = document.getElementById('changeNameBtn');
const resetPassBtn = document.getElementById('resetPassBtn');
const deleteAccBtn = document.getElementById('deleteAccBtn');
const emailInput = document.getElementById('email');
const senhaInput = document.getElementById('senha');

let avatars = [];
let currentUser = null;
let selectedAvatar = null;
let userData = {};

// CONQUISTAS
const achievementsList = [
  {id:"first_login", name:"Primeiro Login", xp:50},
  {id:"select_avatar", name:"Selecionou Avatar", xp:100},
  {id:"high_xp", name:"Acumulou 500 XP", xp:500},
];

// LOGIN / CRIAR CONTA
loginBtn.addEventListener('click', async () => {
  const email = emailInput.value.trim();
  const senha = senhaInput.value.trim();
  if(!email || !senha){ alert("Preencha email e senha!"); return; }
  try{ await signInWithEmailAndPassword(auth,email,senha); }
  catch(e){
    try{ await createUserWithEmailAndPassword(auth,email,senha); }
    catch(err){ alert("Erro ao logar/criar conta: " + err.message); }
  }
});

// ONAUTHSTATECHANGED
onAuthStateChanged(auth, async user => {
  if(user){
    currentUser = user;
    loginBox.style.display = 'none';
    avatarBox.style.display = 'flex';
    achievementsBox.style.display = 'flex';
    loadAvatars();
    loadAchievements();
    unlockAchievement('first_login'); // primeira conquista
  } else {
    currentUser = null;
    loginBox.style.display = 'flex';
    avatarBox.style.display = 'none';
    achievementsBox.style.display = 'none';
    configBox.style.display = 'none';
  }
});

// GEAR BUTTON
gearBtn.addEventListener('click', ()=>{
  if(configBox.style.display==='flex'){ configBox.style.display='none'; }
  else{ configBox.style.display='flex'; loginBox.style.display='none'; avatarBox.style.display='none'; achievementsBox.style.display='none'; }
});
closeConfigBtn.addEventListener('click', ()=>{
  configBox.style.display='none';
  avatarBox.style.display='flex';
  achievementsBox.style.display='flex';
});

// AVATAR LIST
async function loadAvatars(){
  avatarRow.innerHTML = '<p>Carregando...</p>';
  const repoOwner="raphamodelagem3d-lab";
  const repoName="Login";
  const folderPath="Just dance avatars";
  const apiUrl=`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${encodeURIComponent(folderPath)}`;
  try {
    const res = await fetch(apiUrl);
    const files = await res.json();
    avatars = files.filter(f => f.name.match(/\.(png|jpg|jpeg)$/i));
    showAvatars();
  } catch(e){ avatarRow.innerHTML='<p>Erro ao carregar!</p>'; console.error(e); }
}

function showAvatars(){
  avatarRow.innerHTML='';
  avatars.forEach(file=>{
    const img=document.createElement('img');
    img.src=file.download_url;
    img.onclick=()=>{ document.querySelectorAll('.avatar-row img').forEach(i=>i.classList.remove('selected')); img.classList.add('selected'); selectedAvatar=file.download_url; };
    avatarRow.appendChild(img);
  });
}

// SALVAR AVATAR COM REDIRECIONAMENTO SEMPRE
saveAvatarBtn.addEventListener('click', async ()=>{
  if(!selectedAvatar){ 
    alert("Selecione um avatar!"); 
  }
  try{
    if(selectedAvatar){
      await update(ref(db,"users/"+currentUser.uid), {avatar:selectedAvatar});
      await unlockAchievement('select_avatar');
      alert("Avatar salvo! Conquista desbloqueada se for a primeira vez!");
    }
  } catch(e){ 
    alert("Erro ao salvar avatar: "+e.message); 
  } finally {
    // üîó Redireciona SEMPRE para o link correto
    window.location.href = "https://raphamodelagem3d-lab.github.io/Auto-dance-Just-dance-/";
  }
});

// LOAD E RENDER DE CONQUISTAS
function loadAchievements(){
  const achRef = ref(db,"users/"+currentUser.uid);
  onValue(achRef, snapshot=>{
    userData = snapshot.val() || {};
    renderAchievements();
    // XP display
    xpDisplay.textContent = `XP: ${userData.xp || 0}`;
    // desbloqueio autom√°tico de XP
    if((userData.xp || 0) >= 500) unlockAchievement('high_xp');
  });
}

function renderAchievements(){
  achievementsRow.innerHTML = '';
  achievementsList.forEach((a,idx)=>{
    const unlocked = userData.achievements?.[a.id];
    const div = document.createElement('div');
    div.className = 'achievement';
    div.innerHTML = `${unlocked ? '<i class="fa-solid fa-trophy"></i>' : '<i class="fa-regular fa-trophy"></i>'} ${a.name} (+${a.xp} XP)`;
    achievementsRow.appendChild(div);
    setTimeout(()=>div.classList.add('show'), idx*150);
  });
}

// FUN√á√ÉO DE DESBLOQUEIO AUTOM√ÅTICO
async function unlockAchievement(id){
  if(userData.achievements?.[id]) return;
  const achievement = achievementsList.find(a=>a.id===id);
  if(!achievement) return;
  const newAchievements = {...userData.achievements, [id]:true};
  const newXp = (userData.xp || 0) + achievement.xp;
  await update(ref(db,"users/"+currentUser.uid), {achievements: newAchievements, xp: newXp});
}

// CONFIGURA√á√ÉO DE CONTA
changeNameBtn.addEventListener('click', async ()=>{
  const newName = newNameInput.value.trim();
  if(!newName){ alert("Digite um nome!"); return; }
  try{
    await updateProfile(currentUser,{displayName:newName});
    await update(ref(db,"users/"+currentUser.uid),{name:newName});
    alert("Nome alterado com sucesso!");
    newNameInput.value="";
  } catch(e){
    if(e.code==='auth/requires-recent-login'){
      const pw = prompt("Digite sua senha para reautentica√ß√£o:");
      if(!pw) return;
      try{
        const cred = EmailAuthProvider.credential(currentUser.email, pw);
        await reauthenticateWithCredential(currentUser, cred);
        await updateProfile(currentUser,{displayName:newName});
        await update(ref(db,"users/"+currentUser.uid),{name:newName});
        alert("Nome alterado com sucesso!");
        newNameInput.value="";
      } catch(err2){ alert("Erro na reautentica√ß√£o: "+err2.message); }
    } else { alert("Erro ao mudar nome: "+e.message); }
  }
});

resetPassBtn.addEventListener('click', async ()=>{
  try{
    await sendPasswordResetEmail(auth,currentUser.email);
    alert("Email de redefini√ß√£o enviado!");
  } catch(e){ alert("Erro ao enviar email: "+e.message); }
});

deleteAccBtn.addEventListener('click', async ()=>{
  if(!confirm("Tem certeza que deseja apagar sua conta?")) return;
  try{
    await deleteUser(currentUser);
    alert("Conta apagada com sucesso!");
    location.reload();
  } catch(e){
    if(e.code==='auth/requires-recent-login'){
      const pw = prompt("Digite sua senha para confirmar exclus√£o:");
      if(!pw) return;
      try{
        const cred = EmailAuthProvider.credential(currentUser.email, pw);
        await reauthenticateWithCredential(currentUser, cred);
        await deleteUser(currentUser);
        alert("Conta apagada com sucesso!");
        location.reload();
      } catch(err2){ alert("Erro na reautentica√ß√£o/exclus√£o: "+err2.message); }
    } else { alert("Erro ao apagar conta: "+e.message); }
  }
});
</script>
</body>
</html>