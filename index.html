<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login & Seleção de Avatar</title>
<!-- Fonte Tungsten Bold -->
<style>
@font-face {
  font-family: 'Tungsten Bold';
  src: url('Tungsten-Bold.ttf') format('truetype');
  font-weight: bold;
  font-style: normal;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #111 url('IMG_2223.jpeg') no-repeat center center fixed;
  background-size: cover;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding: 20px;
}

.container {
  background: rgba(0, 0, 0, 0.85);
  border-radius: 16px;
  padding: 40px 30px;
  width: 100%;
  max-width: 450px;
  display: flex;
  flex-direction: column;
  align-items: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

h1 {
  text-align: center;
  color: #ff8800; /* laranja */
  font-family: 'Tungsten Bold', Arial, sans-serif;
  margin-bottom: 25px;
  font-size: 28px;
  font-weight: bold;
}

.login-box, .avatar-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px; 
  width: 100%;
}

input[type="email"], input[type="password"], button {
  padding: 12px 18px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #555;
  width: 100%;
  max-width: 300px;
  outline: none;
  background-color: #222;
  color: #fff;
  transition: background-color 0.2s, transform 0.2s;
}

input[type="email"]:focus, input[type="password"]:focus {
  border-color: #ff8800;
  background-color: #333;
}

button {
  background-color: #ff8800;
  color: #111;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
  transition: background-color 0.2s, transform 0.2s;
}

button:hover {
  background-color: #ff9900;
  transform: scale(1.03);
}

.avatar-row { 
  display: flex;
  overflow-x: auto;
  gap: 12px;
  padding: 8px;
  max-width: 100%;
}

.avatar-row img { 
  width: 80px; 
  height: 80px; 
  border-radius: 10px;
  border: 2px solid transparent; 
  cursor: pointer;
  transition: transform 0.2s, border-color 0.2s; 
  object-fit: cover;
  flex-shrink: 0;
}

.avatar-row img:hover { 
  transform: scale(1.1); 
  border-color: #ff8800; 
}

.avatar-row img.selected { 
  border-color: #ffaa55; 
  box-shadow: 0 0 6px #ffaa55;
}

.pagination { 
  display: flex; 
  justify-content: space-between; 
  width: 100%; 
  max-width: 300px;
  margin-top: 12px;
}

.pagination button {
  background-color: #ff8800;
  color: #111;
  font-weight: normal;
  padding: 8px 14px;
  border-radius: 6px;
}

.pagination button:hover {
  background-color: #ff9900;
}
</style>
</head>
<body>
<div class="container">
  <!-- LOGIN -->
  <div class="login-box" id="loginBox">
    <h1>Entrar</h1>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button id="loginBtn">Login / Criar conta</button>
  </div>

  <!-- SELEÇÃO DE AVATAR -->
  <div class="avatar-box" id="avatarBox" style="display:none;">
    <h1>Escolha seu Avatar</h1>
    <div class="avatar-row" id="avatarRow"></div>
    <div class="pagination">
      <button id="prevBtn">Anterior</button>
      <button id="nextBtn">Próximo</button>
    </div>
    <button id="saveAvatarBtn" style="margin-top:15px;">Salvar Avatar e Continuar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCA2XWZzavTNdHi_w8X5aASfBTfoLVsghY",
  authDomain: "auto-dance.firebaseapp.com",
  databaseURL: "https://auto-dance-default-rtdb.firebaseio.com",
  projectId: "auto-dance",
  storageBucket: "auto-dance.firebasestorage.app",
  messagingSenderId: "960760470726",
  appId: "1:960760470726:web:f5af55d01df6a2be0d4bc7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Elementos
const loginBtn = document.getElementById('loginBtn');
const loginBox = document.getElementById('loginBox');
const avatarBox = document.getElementById('avatarBox');
const avatarRow = document.getElementById('avatarRow');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const saveAvatarBtn = document.getElementById('saveAvatarBtn');
const emailInput = document.getElementById('email');
const senhaInput = document.getElementById('senha');

let avatars = [];
let currentPage = 0;
const avatarsPerPage = 8;
let selectedAvatar = null;
let currentUser = null;

// LOGIN / CRIAR CONTA
loginBtn.addEventListener('click', async () => {
  const email = emailInput.value.trim();
  const senha = senhaInput.value.trim();
  if(!email||!senha){ alert("Preencha email e senha!"); return; }

  try{ await signInWithEmailAndPassword(auth,email,senha); }
  catch(e){ try{ await createUserWithEmailAndPassword(auth,email,senha); } catch(err){ alert(err.message); return; } }
});

// DETECTA LOGIN
onAuthStateChanged(auth, async user => {
  if(user){
    currentUser = user;
    loginBox.style.display = 'none';
    avatarBox.style.display = 'flex';

    // Carrega avatar do usuário se já tiver
    const userRef = ref(db, "users/"+user.uid);
    const snapshot = await get(userRef);
    if(snapshot.exists() && snapshot.val().avatar){
      selectedAvatar = snapshot.val().avatar;
    }

    loadAvatars();
  } else {
    currentUser = null;
    loginBox.style.display = 'flex';
    avatarBox.style.display = 'none';
  }
});

// CARREGA AVATARES DO GITHUB
async function loadAvatars(){
  avatarRow.innerHTML = '<p>Carregando avatares...</p>';
  const repoOwner = "raphamodelagem3d-lab";
  const repoName = "Login";
  const folderPath = "Just dance avatars";
  const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${encodeURIComponent(folderPath)}`;

  try{
    const response = await fetch(apiUrl);
    const files = await response.json();
    avatars = files.filter(f => f.name.endsWith('.png') || f.name.endsWith('.jpg') || f.name.endsWith('.jpeg'));
    currentPage = 0;
    showPage(currentPage);
  } catch(err){
    avatarRow.innerHTML = '<p>Erro ao carregar avatares!</p>';
    console.error(err);
  }
}

// MOSTRA PÁGINA DE AVATARES
function showPage(page){
  avatarRow.innerHTML = '';
  const start = page*avatarsPerPage;
  const end = start+avatarsPerPage;
  avatars.slice(start,end).forEach(file=>{
    const img = document.createElement('img');
    img.src = file.download_url;
    img.alt = file.name;
    if(selectedAvatar===file.download_url) img.classList.add('selected');
    img.onclick = () => {
      document.querySelectorAll('.avatar-row img').forEach(i=>i.classList.remove('selected'));
      img.classList.add('selected');
      selectedAvatar = file.download_url;
    };
    avatarRow.appendChild(img);
  });
}

prevBtn.addEventListener('click', ()=>{ if(currentPage>0){ currentPage--; showPage(currentPage); }});
nextBtn.addEventListener('click', ()=>{ if((currentPage+1)*avatarsPerPage<avatars.length){ currentPage++; showPage(currentPage); }});

// SALVA AVATAR E REDIRECIONA
saveAvatarBtn.addEventListener('click', async ()=>{
  if(!selectedAvatar) return alert("Selecione um avatar!");

  try {
    await set(ref(db, "users/" + currentUser.uid), { avatar: selectedAvatar });
    // Redireciona para o site Autodance com avatar salvo
    window.location.href = "https://raphamodelagem3d-lab.github.io/Auto-dance-Just-dance-/";
  } catch(err) {
    alert("Erro ao salvar avatar: " + err.message);
  }
});